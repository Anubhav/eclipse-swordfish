<?xml version="1.0" encoding="UTF-8"?>
<!--============================================================================
    Copyright (c) 2007 Deutsche Post AG.
    All rights reserved. This program and the accompanying materials
    are made available under the terms of the Eclipse Public License v1.0
    which accompanies this distribution, and is available at
    http://www.eclipse.org/legal/epl-v10.html
    
    Contributors:
       Deutsche Post AG - initial API and implementation
 ============================================================================-->
<!DOCTYPE beans PUBLIC "-//SPRING//DTD BEAN//EN" "http://www.springframework.org/dtd/spring-beans.dtd">
<!-- 
    $Revision: 1.30.12.2 $
    Author: Christian Schroeder
-->
<beans>
    <description>SOP Configuration Manager Spring Component: (Technical) Service Participant
        Configuration</description>
    <!--
        Technical Service Participant Configuration
    -->
    <bean id="org.eclipse.swordfish.configrepos.springbeans.ParticipantRemoteFallbackConfigSource"
        class="org.eclipse.swordfish.configrepos.configuration.sources.DirectoryConfigurationSource">
        <property name="basePath" ref="sp_workdirectory"/>
        <property name="filename" value="sp_fallbackcfg"/>
        <property name="returnEmptyForNonAvailable" value="true"/>
        <property name="resourceManager"
            ref="org.eclipse.swordfish.configrepos.spring.FileResourceManagerBean"/>
        <property name="validator" ref="org.eclipse.swordfish.configrepos.springbeans.ConfigurationValidator" />
        <property name="schemasource" ref="org.eclipse.swordfish.configrepos.springbeans.ParticipantConfigurationSchemaSource" />        
    </bean>
    <bean name="org.eclipse.swordfish.configrepos.springbeans.ParticipantFailsafeRemoteConfigSource"
        class="org.eclipse.swordfish.configrepos.configuration.sources.FailsafeConfigurationSource">
        <property name="mainConfigurationSource">
            <ref bean="org.eclipse.swordfish.configrepos.springbeans.ParticipantRemoteConfigSource"/>
        </property>
        <property name="fallbackConfigurationSource">
            <ref bean="org.eclipse.swordfish.configrepos.springbeans.ParticipantRemoteFallbackConfigSource"/>
        </property>
    </bean>
    <!--
        Merger for local and remote configuration
    -->
    <bean id="org.eclipse.swordfish.configrepos.springbeans.ParticipantLocalConfigSource"
        class="org.eclipse.swordfish.configrepos.configuration.sources.DirectoryConfigurationSource">
        <property name="basePath" ref="sp_workdirectory"/>
        <property name="filename" value="sp_localcfg"/>
        <property name="returnEmptyForNonAvailable" value="true"/>
        <property name="resourceManager"
            ref="org.eclipse.swordfish.configrepos.spring.FileResourceManagerBean"/>
        <property name="validator" ref="org.eclipse.swordfish.configrepos.springbeans.ConfigurationValidator" />
        <property name="schemasource" ref="org.eclipse.swordfish.configrepos.springbeans.ParticipantConfigurationSchemaSource" />        
    </bean>
    <bean name="org.eclipse.swordfish.configrepos.springbeans.ParticipantMergingConfigSource"
        class="org.eclipse.swordfish.configrepos.configuration.sources.MergingConfigurationSource"
        autowire="byName">
        <description>This merger will combine local and remote configuration sources into a
            participant specific effective configuration</description>
        <property name="configSources">
            <list>
                <ref bean="org.eclipse.swordfish.configrepos.springbeans.ParticipantFailsafeRemoteConfigSource"/>
                <ref bean="org.eclipse.swordfish.configrepos.springbeans.ParticipantLocalConfigSource"/>
            </list>
        </property>
    </bean>
    <!--
        Resources 
    -->
    <bean id="org.eclipse.swordfish.configrepos.springbeans.ParticipantRemoteFallbackResourceSource"
        class="org.eclipse.swordfish.configrepos.resource.sources.DirectoryResourceSource">
        <property name="basePath" ref="sp_workdirectory"/>
        <property name="resourceManager"
            ref="org.eclipse.swordfish.configrepos.spring.FileResourceManagerBean"/>
    </bean>
    <bean id="org.eclipse.swordfish.configrepos.springbeans.ParticipantFailsafeResourceSource"
        class="org.eclipse.swordfish.configrepos.resource.sources.FailsafeResourceSource">
        <property name="mainResourceSource"
            ref="org.eclipse.swordfish.configrepos.springbeans.ParticipantRemoteResourceSource"/>
        <property name="fallbackResourceSource"
            ref="org.eclipse.swordfish.configrepos.springbeans.ParticipantRemoteFallbackResourceSource"/>
    </bean>
    <!-- 
        Cache interceptor instantiation
    -->
    <bean id="org.eclipse.swordfish.configrepos.springbeans.ParticipantCachedConfigSource"
        class="org.eclipse.swordfish.configrepos.configuration.sources.CachingConfigurationSource">
        <property name="cacheProvider"
            ref="org.eclipse.swordfish.configrepos.springbeans.BootstrapOSCacheProvider"/>
        <property name="cacheTarget" ref="org.eclipse.swordfish.configrepos.springbeans.ParticipantMergingConfigSource"/>
        <property name="cacheProfile" value="config"/>
    </bean>
    <bean id="org.eclipse.swordfish.configrepos.springbeans.ParticipantCachedResourceSource" lazy-init="true"
        class="org.eclipse.swordfish.configrepos.resource.sources.CachingResourceSource">
        <property name="cacheProvider"
            ref="org.eclipse.swordfish.configrepos.springbeans.BootstrapOSCacheProvider"/>
        <property name="cacheTarget" ref="org.eclipse.swordfish.configrepos.springbeans.ParticipantFailsafeResourceSource"/>
        <property name="cacheProfile" value="config"/>
    </bean>
    <!--
        Resource reader for sbb configuration schemas
    -->
    <bean id="org.eclipse.swordfish.configrepos.springbeans.ParticipantConfigurationSchemaSource"
        class="org.eclipse.swordfish.configrepos.resource.sources.OverrideableResourceSource" singleton="true">
        <property name="sources">
            <list>
                <ref
                    bean="org.eclipse.swordfish.configrepos.springbeans.SBBLibraryConfigurationSchemaClasspathSource"/>
                <ref bean="org.eclipse.swordfish.configrepos.springbeans.ParticipantRemoteFallbackResourceSource"/>
            </list>
        </property>
    </bean>
    <!--
		Configuration Repository Manager for the (Technical) Service Participants
    -->
    <bean id="cfgmngr_sp"
        class="org.eclipse.swordfish.configrepos.ConfigurationRepositoryManagerExternalizablelImpl"
        abstract="true" autowire="byName">
        <property name="localResourceBase" ref="sp_workdirectory"/>
        <property name="bootConfiguration" ref="boot_config"/>
        <property name="configSource" ref="org.eclipse.swordfish.configrepos.springbeans.ParticipantCachedConfigSource"/>
        <property name="resourceSource" ref="org.eclipse.swordfish.configrepos.springbeans.ParticipantCachedResourceSource"/>
        <property name="skipRemoteRepositoryCalls">
            <value>$sbb_boot{Participant[@sopcs:name="/"]/ConfigurationRepositoryManager/SkipRemoteConfigCall}</value>
        </property>
        <property name="jxPathContextFactory">
        	<ref bean="org.eclipse.swordfish.configrepos.springbeans.JXPathContextFactory"/>
        </property>
        <property name="reverseLinkList">
            <list>
                <ref bean="org.eclipse.swordfish.configrepos.springbeans.ParticipantFailsafeRemoteConfigSource"/>
                <ref bean="org.eclipse.swordfish.configrepos.springbeans.ParticipantFailsafeResourceSource"/>
                <ref bean="org.eclipse.swordfish.configrepos.springbeans.ParticipantRemoteFallbackConfigSource"/>
                <ref bean="org.eclipse.swordfish.configrepos.springbeans.ParticipantRemoteFallbackResourceSource"/>
                <ref bean="org.eclipse.swordfish.configrepos.springbeans.ParticipantLocalConfigSource"/>
            </list>
        </property>
    </bean>
</beans>
